<div id="welcome">
  <div class="KanjiLookup-container KanjiLookup-container--noResult">
    <h1 class="welcome">WELCOME!</h1>
    <p class="welcome-text">
      To look up Kanji, enter them into the box above and press Enter or press
      the search button.
    </p>
    <p class="welcome-text">
      You can also press <span class="key">CTRL</span> + <span class="key">SHIFT</span> +
      <span class="key">K</span> anywhere in Anki to search for the highlighted
      characters.
    </p>
  </div>
</div>

<div id="noresult" style="display: none;">
  <div class="KanjiLookup-container KanjiLookup-container--noResult">
    <h1>No result found for character</h1>
    <h1 class="kanji">仮</h1>
  </div>
</div>

<div id="result" style="display: none;">
  <div class="KanjiLookup-container">
    <div class="KanjiLookup-details">
      <div class="KanjiLookup-player">
        <div class="KanjiLookup-player">
          <div class="playerContainer">
            <h3 class="playerTitle">Stroke order</h3>
            <div id="strokeorder"></div>
            <div class="playerControls">
              <button id="strokeorder_p">
                <span class="material-icons"> skip_previous </span>
              </button>
              <button id="strokeorder_s">
                <span class="material-icons"> pause </span>
              </button>
              <button id="strokeorder_g">
                <span class="material-icons"> play_arrow </span>
              </button>
              <button id="strokeorder_n">
                <span class="material-icons"> skip_next </span>
              </button>
              <button id="strokeorder_r">
                <span class="material-icons"> stop </span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="KanjiLookup-description">
        <h1 class="fontExamplesHeader">Font examples</h1>
        <span class="fontExample" style="font-family: 'kanji_font1'">仮</span>
        <span class="fontExample" style="font-family: 'kanji_font2'">仮</span>
        <span class="fontExample" style="font-family: 'kanji_font3'">仮</span>
        <span class="fontExample" style="font-family: 'kanji_font4'">仮</span>
        <div class="separator"></div>
        <div class="tags">
        </div>
        <div class="keywords">
          <h3>Keywords:</h3>
          <span id="keywords">-</span>
        </div>
        <div class="keywords">
          <h3>Meanings:</h3>
          <span id="meanings">-</span>
        </div>
        <div class="readings">
          <ul>
            <li>
              <h4>Onyomi:</h4>
              <span id="onyomi"></span>
            </li>
            <li>
              <h4>Kunyomi:</h4>
              <span id="kunyomi"></span>
            </li>
            <li>
              <h4>Nanori:</h4>
              <span id="nanori"></span>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="KanjiLookup-primitives">
      <h2>Primitives</h2>
      <span id="primitives"></span>
    </div>
    <div class="KanjiLookup-words">
      <h2>Words</h2>
      <span id="words"></span>
    </div>
    <div class="KanjiLookup-actions">
      <button onclick="recognition_card_click(event);" id="recognition_card_btn" class="button">Create Recognition Card</button>
      <button onclick="production_card_click(event);" id="production_card_btn" class="button">Create Production Card</button>
    </div>
    <div class="KanjiLookup-stories">
      <h3>Stories</h3>
      <span id="stories"></span>
    </div>
    <div class="KanjiLookup-actions">
      <button onclick="set_custom_keyword();" class="button secondary">Set Custom Keyword</button>
      <button onclick="set_custom_story();" class="button secondary">Set Custom Story</button>
    </div>
    <div class="KanjiLookup-radicals">
      <h2>Radicals</h2>
      <span id="radicals"></span>
    </div>
  </div>
</div>

<script>
  let dmak = null;
  let data = null;
  let last_character = null;

  function wrap_list(list, intro, outro, dash_on_empty=true)
  {
    if (list.length < 1)
      return dash_on_empty ? '-' : '';
    return intro + list.join(outro+intro) + outro;
  }

  function search(text)
  {
    pycmd('open-' + text);
  }

  function search_dict(text)
  {
    pycmd('search_dict-' + text);
  }

  function show_word_notes(notes)
  {
    pycmd('show_word-' + notes.join(','));
  }

  function primitive_click()
  {
    search($(this).data('character'));
  }

  function word_click(evt)
  {
    if (evt.shiftKey)
    {
      search_dict($(this).data('word-kanji'));
    }
    else
    {
      var word_idx = $(this).data('word-idx');

      if (word_idx === undefined)
        return;

      var idx = parseInt(word_idx);

      const we = data.words[idx];
      const nids = we[2];

      show_word_notes(nids);
    }
  }

  function recognition_card_click(evt)
  {
    if (data.recognition_card_id !== null)
    {
      if (data.recognition_card_id < 0)
        pycmd('mark-recognition-' + data.character + '-0');
      else
        pycmd('show_card_id-' + data.recognition_card_id);
    }
    else
    {
      if (evt.shiftKey)
        pycmd('mark-recognition-' + data.character + '-1');
      else
        pycmd('create-recognition-' + data.character);
    }
  }

  // Isn't copy paste code because you are lazy fun?
  function production_card_click(evt)
  {
    if (data.production_card_id !== null)
    {
      if (data.production_card_id < 0)
        pycmd('mark-production-' + data.character + '-0');
      else
        pycmd('show_card_id-' + data.production_card_id);
    }
    else
    {
      if (evt.shiftKey)
        pycmd('mark-production-' + data.character + '-1');
      else
        pycmd('create-production-' + data.character);
    }
  }

  function set_custom_keyword()
  {
    pycmd('custom_keyword-' + data.character + '-' + (data.usr_keyword ? data.usr_keyword : ''));
  }

  function set_custom_story()
  {
    pycmd('custom_story-' + data.character + '-' + (data.usr_story ? data.usr_story : ''));
  }

  $('#strokeorder_p').click(function() { dmak.eraseLastStrokes(1); });
  $('#strokeorder_s').click(function() { dmak.pause(); });
  $('#strokeorder_g').click(function() { dmak.render(); });
  $('#strokeorder_n').click(function() { dmak.renderNextStrokes(1); });
  $('#strokeorder_r').click(function() { dmak.erase(); });

  function set_data(data_b64_json)
  {
    var data_json = atob(data_b64_json);
    data = JSON.parse(data_json);

    // Scroll up if new character was opened
    var new_character = (data !== null && data.has_result) ? data.character : null;
    if (last_character === null || new_character != last_character)
      window.scrollTo(0, 0);
    last_character = new_character;

    // Suspend existing dmak instance
    if (dmak !== null)
    {
      dmak.cancel_prepare = true;
      delete dmak;
    }

    $('#welcome').toggle(data === null);
    $('#noresult').toggle(data !== null && !data.has_result);
    $('#result').toggle(data !== null && data.has_result);

    if (data !== null && !data.has_result)
      $('.kanji').html(data.character);

    else if (data !== null && data.has_result)
    {
      $('#strokeorder').html('');
      dmak = new Dmak(data.character, {'element': 'strokeorder', 'uri': kanjivg_uri, 'height': 220, 'width': 220, 'step': 0.015});

      $('.fontExample').html(data.character);

      tags = [];
      if (data.frequency_rank < 999999) tags.push('Frequency #' + data.frequency_rank.toString())
      if (data.jlpt !== null) tags.push('JLPT N' + data.jlpt.toString())
      if (data.kanken !== null) tags.push('Kanken ' + data.kanken.toString())
      if (data.grade !== null)
      {
        const num_conv = '０１２３４５６７８９';
        if (data.grade <= 6) tags.push('小学校' + num_conv[data.grade] + '年');
        if (data.grade == 8) tags.push('中学年');
        if (data.grade <= 8) tags.push('常用');
        if (data.grade >= 9 && data.grade <= 10) tags.push('人名用');
      }
      if (data.heisig_id5 !== null) tags.push('RTK (1-5) ' + data.heisig_id5.toString());
      if (data.heisig_id6 !== null) tags.push('RTK (6+) ' + data.heisig_id6.toString());
      $('.tags').html(wrap_list(tags, '<div class="tag">', '</div>', false));

      $('#onyomi').html(data.onyomi.length ? data.onyomi.join(', ') : '-');
      $('#kunyomi').html(data.kunyomi.length ? data.kunyomi.join(', ') : '-');
      $('#nanori').html(data.nanori.length ? data.nanori.join(', ') : '-');

      var has_primitives = data.primitives.length > 0 && !(data.primitives.length == 1 && data.primitives[0] == data.character);
      $('.KanjiLookup-primitives').toggle(has_primitives);
      $('#primitives').empty();

      if (has_primitives)
      {
        var primitives_pts = [];

        for (const p_data of data.primitives_detail)
        {
          var keywords = [];
          if (p_data.usr_keyword)
            keywords.push(p_data.usr_keyword);
          if (p_data.heisig_keyword5 && !keywords.includes(p_data.heisig_keyword5))
            keywords.push(p_data.heisig_keyword5);
          if (p_data.heisig_keyword6 && !keywords.includes(p_data.heisig_keyword6))
            keywords.push(p_data.heisig_keyword6);
          for (const pk of p_data.primitive_keywords)
            keywords.push('<span class="primitive_keyword">' + pk + '</span>');
          var keywords_txt = keywords.length ? keywords.join(', ') : '-';

          var meanings_txt = p_data.meanings.length ? p_data.meanings.join(', ') : '-';

          var primitive_alternatives_txt = p_data.primitive_alternatives.length ? p_data.primitive_alternatives.join(', ') : '-';
          
          primitives_pts.push(
            '<button class="primitive" data-character="' + p_data.character + '">' + p_data.character + '<div class="primitiveDetails">' +
              '<div class="primitiveDetails-keywords"><h3>Keywords:</h3> ' + keywords_txt + '</div>' +
              '<div class="primitiveDetails-meanings"><h3>Meanings:</h3> ' + meanings_txt + '</div>' +
              '<div class="primitiveDetails-alternatives"><h3>Alternatives:</h3> ' + primitive_alternatives_txt + '</div>' +
            '</div></button>'
          );
        }

        $('#primitives').html(primitives_pts.join(''));

        $('.primitive').click(primitive_click);
      }

      var max_words = 20;
      word_pts = [];

      for (var i = 0; i < data.words.length; i++)
      {
        if (word_pts.length >= max_words)
            break;

        const we = data.words[i];
        const w = we[0];
        const r = we[1];

        word_pts.push('<button class="word" data-word-kanji="' + w + '" data-word-idx="' + i + '"><ruby>' + w + '<rt>' + r + '</rt></ruby></button>');
      }
      for (var i = 0; i < data.words_default.length; i++)
      {
        if (word_pts.length >= max_words)
            break;

        const we = data.words_default[i];
        const w = we[0];
        const r = we[1];

        if (data.words.some(
          function(existing_we) { return (w == existing_we[0] && r == existing_we[1]); }
        ))
          continue;

        word_pts.push('<button class="word word_default" data-word-kanji="' + w + '"><ruby>' + w + '<rt>' + r + '</rt></ruby></button>');
      }
      $('.KanjiLookup-words').toggle(word_pts.length > 0);
      $('#words').html(word_pts.join(''));
      $('.word').click(word_click);

      $('.KanjiLookup-radicals').toggle(data.radicals.length > 0);
      $('#radicals').html(
        wrap_list(
          data.radicals,
          '<button class="radical">',
          '</button>')
      );

      var keywords = [];
      if (data.usr_keyword)
        keywords.push(data.usr_keyword);
      if (data.heisig_keyword5 && !keywords.includes(data.heisig_keyword5))
        keywords.push(data.heisig_keyword5);
      if (data.heisig_keyword6 && !keywords.includes(data.heisig_keyword6))
        keywords.push(data.heisig_keyword6);
      for (const pk of data.primitive_keywords)
        keywords.push('<span class="primitive_keyword">' + pk + '</span>');
      $('#keywords').html(keywords.length ? keywords.join(', ') : '-');

      $('#meanings').html(data.meanings.length ? data.meanings.join(', ') : '-');

      var stories = [];
      if (data.usr_story)
        stories.push(data.usr_story.split('\n').join('<br>'));
      if (data.heisig_story)
      {
        var heisig_story = data.heisig_story;
        if (data.heisig_comment)
          heisig_story += '<br><br>' + data.heisig_comment;
        stories.push(heisig_story);
      }
      for (const ks of data.koohi_stories)
        stories.push(ks);

      $('#stories').html(
        wrap_list(stories, '<p class="story">', '</p>')
      );

      function setup_card_btn(id, data, name) {
        txt = '';
        title = null;
        if (data === null)
        {
          txt = 'Create ' + name + ' Card';
          title = 'Shift click to mark as known';
        }
        if (data > 0) txt = 'Show ' + name + ' Card';
        if (data < 0) txt = 'Unmark ' + name + ' as known';

        $(id).html(txt);
        $(id).prop('title', title);
      }

      setup_card_btn('#recognition_card_btn', data.recognition_card_id, 'Recognition');
      setup_card_btn('#production_card_btn', data.production_card_id, 'Production');
    }
  }

</script>
