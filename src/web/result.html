<div class="center">
    <div id="strokeorder"></div>
    <div class="kanji font1">仮</div>
    <div class="kanji font2">仮</div>
    <div class="kanji font3">仮</div>
</div>

<div class="center">
    <button id="strokeorder_p">❮</button>
    <button id="strokeorder_s">⏸</button>
    <button id="strokeorder_g">▶</button>
    <button id="strokeorder_n">❯</button>
    <button id="strokeorder_r">⏹</button>
</div>

<div id="primitive_alternatives" class="center"></div>
<div id="primitives" class="center"></div>

<p id="keywords"></p>
<p id="meanings"></p>

<div id="words" class="font1 center"></div>

<p id="story"></p>

<table>
    <tr><td>Onyomi</td><td id="onyomi">None</td></tr>
    <tr><td>Kunyomi</td><td id="kunyomi">None</td></tr>
    <tr><td>Nanori</td><td id="nanori">None</td></tr>
</table>

<table style="margin-top:10px;">
    <tr><td>Frequency Rank</td><td id="frequency_rank">-</td></tr>
    <tr><td>Grade</td><td id="grade">-</td></tr>
    <tr><td>JLPT</td><td id="jlpt">-</td></tr>
    <tr><td>Kanken</td><td id="kanken">-</td></tr>
    <tr><td>RTK (1-5)</td><td id="heisig_id5">-</td></tr>
    <tr><td>RTK (6+)</td><td id="heisig_id6">-</td></tr>
</table>

<div style="margin-top:10px;">
    <button onclick="recognition_card_click();" id="recognition_card_btn"></button>
    <button onclick="production_card_click();" id="production_card_btn"></button>
    <br><br>
    <button onclick="set_custom_keyword();" id="custom_keyword_btn">Set custom Keyword</button>
    <button onclick="set_custom_story();" id="custom_story_btn">Set custom story</button>
</div>


<script>
    function recognition_card_click()
    {
        if (data.recognition_card_id !== null)
            pycmd('show_card_id-' + data.recognition_card_id);
        else
            pycmd('create-recognition-' + data.character);
    }

    function production_card_click()
    {
        if (data.production_card_id !== null)
            pycmd('show_card_id-' + data.production_card_id);
        else
            pycmd('create-production-' + data.character);
    }

    function search(text)
    {
        pycmd('open-' + text);
    }

    function show_word(elem)
    {
        var idx = parseInt(elem.getAttribute("data-word-idx"));

        const we = data.words[idx];
        const nids = we[2];

        pycmd('show_word-' + nids.join(',').toString());
    }

    function set_custom_keyword()
    {
        pycmd('custom_keyword-' + data.character + '-' + (data.usr_keyword ? data.usr_keyword : ''));
    }

    function set_custom_story()
    {
        pycmd('custom_story-' + data.character + '-' + (data.usr_story ? data.usr_story : ''));
    }


    for (const ke of document.querySelectorAll('.kanji'))
        ke.innerHTML = data.character;


    var max_words = 20;
    word_entries = [];

    for (var i = 0; i < data.words.length; i++)
    {
        if (word_entries.length >= max_words)
            break;

        const we = data.words[i];
        const w = we[0];
        const r = we[1];
        word_entries.push('<div class="word word_clickable" data-word-idx="' + i + '" onclick="show_word(this);"><ruby>' + w + '<rt>' + r + '</rt></ruby></div>');
    }
    for (var i = 0; i < data.words_default.length; i++)
    {
        if (word_entries.length >= max_words)
            break;

        const we = data.words_default[i];
        const w = we[0];
        const r = we[1];

        if (data.words.some(
            function(existing_we) { return (w == existing_we[0] && r == existing_we[1]); }
        ))
            continue;

        word_entries.push('<div class="word word_default"><ruby>' + w + '<rt>' + r + '</rt></ruby></div>');
    }
    document.getElementById('words').innerHTML = word_entries.join('　');


    var keywords = [];
    if (data.usr_keyword)
        keywords.push(data.usr_keyword);
    if (data.heisig_keyword5 && !keywords.includes(data.heisig_keyword5))
        keywords.push(data.heisig_keyword5);
    if (data.heisig_keyword6 && !keywords.includes(data.heisig_keyword6))
        keywords.push(data.heisig_keyword6);
    document.getElementById('keywords').innerHTML = keywords.join(', ');

    var meanings = [];
    for (const m of data.meanings)
    {
        if (!keywords.includes(m))
            meanings.push(m);
    }
    document.getElementById('meanings').innerHTML = meanings.join(', ');

    if (data.primitive_alternatives.length)
    {
        primitive_alternatives_txt = 'Primitive Forms:<div id="primitive_alternatives_txt" class="font1">' + data.primitive_alternatives.join('　') + '</div>';
        document.getElementById('primitive_alternatives').innerHTML = primitive_alternatives_txt;
    }

    primitives_elem = document.getElementById('primitives');
    if (data.primitives.length != 1 || data.primitives[0] != data.character)
    {
        for (const p_data of data.primitives_detail)
        {
            tooltip_parts = [];

            if (p_data.primitive_alternatives.length)
                tooltip_parts.push('<div>' + p_data.primitive_alternatives.join('　') + '</div>');

            var keywords = [];
            if (p_data.usr_keyword)
                keywords.push(p_data.usr_keyword);
            if (p_data.heisig_keyword5 && !keywords.includes(p_data.heisig_keyword5))
                keywords.push(p_data.heisig_keyword5);
            if (p_data.heisig_keyword6 && !keywords.includes(p_data.heisig_keyword6))
                keywords.push(p_data.heisig_keyword6);
            if (keywords.length)
                tooltip_parts.push('<div>' + keywords.join(', ') + '</div>');

            var meanings = [];
            for (const m of p_data.meanings)
            {
                if (!keywords.includes(m))
                    meanings.push(m);
            }
            if (meanings.length)
                tooltip_parts.push('<div>' + meanings.join(', ') + '</div>');
            
            if (tooltip_parts.length > 0)
                tooltip = tooltip_parts.join('')
            else
                tooltip = 'No Info Available';

            primitives_elem.innerHTML +=
                '<div class="primitive" onclick="search(this.querySelector(\'.primitive_text\').innerHTML);">' +
                    '<span class="primitive_text font1">' + p_data.character + '</span>' +
                    '<span class=\"primitive_tooltip\">' + tooltip + '</span>' +
                '</div>';
        }
    }

    var story_parts = [];
    if (data.usr_story)
        story_parts.push(data.usr_story);
    if (data.heisig_story)
        story_parts.push(data.heisig_story);
    if (data.heisig_comment)
        story_parts.push(data.heisig_comment);
    for (const ks of data.koohi_stories)
        story_parts.push(ks);
    var story = story_parts.join('<br><br>');
    document.getElementById('story').innerHTML = story;

    if (data.onyomi.length)
        document.getElementById('onyomi').innerHTML = data.onyomi.join(', ');
    if (data.kunyomi.length)
        document.getElementById('kunyomi').innerHTML = data.kunyomi.join(', ');
    if (data.nanori.length)
        document.getElementById('nanori').innerHTML = data.nanori.join(', ');

    if (data.frequency_rank !== null && data.frequency_rank < 999999)
        document.getElementById('frequency_rank').innerHTML = data.frequency_rank.toString();
    if (data.grade !== null)
        document.getElementById('grade').innerHTML = data.grade.toString();
    if (data.jlpt !== null)
        document.getElementById('jlpt').innerHTML = data.jlpt.toString();
    if (data.kanken !== null)
        document.getElementById('kanken').innerHTML = data.kanken.toString();
    if (data.heisig_id5 !== null)
        document.getElementById('heisig_id5').innerHTML = data.heisig_id5.toString();
    if (data.heisig_id6 !== null)
        document.getElementById('heisig_id6').innerHTML = data.heisig_id6.toString();


    var dmak = new Dmak(data.character, {'element': 'strokeorder', 'uri': kanjivg_uri, 'height': 120, 'width': 120, 'step': 0.015});

    document.getElementById('strokeorder_p').onclick = function () {
        dmak.eraseLastStrokes(1);
    };

    document.getElementById('strokeorder_s').onclick = function () {
        dmak.pause();
    };

    document.getElementById('strokeorder_g').onclick = function () {
        dmak.render();
    };

    document.getElementById('strokeorder_n').onclick = function () {
        dmak.renderNextStrokes(1);
    };

    document.getElementById('strokeorder_r').onclick = function () {
        dmak.erase();
    };


    document.getElementById('recognition_card_btn').innerHTML = (data.recognition_card_id ? 'Show' : 'Create') + ' Recognition Card';
    document.getElementById('production_card_btn').innerHTML = (data.production_card_id ? 'Show' : 'Create')  + ' Production Card';
</script>
